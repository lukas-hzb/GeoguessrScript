name: Add Location from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  add-location:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[Meta Submission]')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3

      - name: Parse Issue and Update Data
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const issueBody = context.payload.issue.body;
            
            // Try extracting JSON from code block
            let jsonMatch = issueBody.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            
            // Fallback: find first { ... } block
            if (!jsonMatch) {
                console.log("No code block found, trying raw JSON search...");
                const firstBrace = issueBody.indexOf('{');
                const lastBrace = issueBody.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                    jsonMatch = [null, issueBody.substring(firstBrace, lastBrace + 1)];
                }
            }

            if (!jsonMatch) {
              console.log("No JSON found in body.");
              core.setFailed("No JSON block found in issue body.");
              return;
            }
            
            let submission;
            try {
              submission = JSON.parse(jsonMatch[1]);
            } catch (e) {
              console.error("Invalid JSON:", e);
              core.setFailed("Invalid JSON format.");
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "Error: Invalid JSON format."
              });
              return;
            }
            
            // Validate submission format
            if (!submission.action || !submission.panoid) {
                core.setFailed("Invalid submission format. Expected: {action, panoid, ...}");
                return;
            }

            const LOCATIONS_FILE = 'data/locations.json';
            const METAS_FILE = 'data/metas.json';

            // Load existing files
            let locations = {};
            let metas = [];
            
            if (fs.existsSync(LOCATIONS_FILE)) {
              locations = JSON.parse(fs.readFileSync(LOCATIONS_FILE, 'utf8'));
            }
            if (fs.existsSync(METAS_FILE)) {
              metas = JSON.parse(fs.readFileSync(METAS_FILE, 'utf8'));
            }
            
            const panoid = submission.panoid;

            // Ensure location entry exists with metadata and correct structure
            if (!locations[panoid] || Array.isArray(locations[panoid])) {
                const oldMetas = Array.isArray(locations[panoid]) ? locations[panoid] : [];
                locations[panoid] = {
                    metas: oldMetas,
                    lat: submission.lat || (submission.meta ? submission.meta.lat : null),
                    lng: submission.lng || (submission.meta ? submission.meta.lng : null),
                    country: submission.country || (submission.meta ? submission.meta.country : null),
                    region: submission.region || (submission.meta ? submission.meta.region : null)
                };
            } else {
                // Update metadata if provided and currently missing or updated
                if (submission.lat) locations[panoid].lat = submission.lat;
                if (submission.lng) locations[panoid].lng = submission.lng;
                if (submission.country) locations[panoid].country = submission.country;
                if (submission.region) locations[panoid].region = submission.region;
            }

            if (submission.action === "add_meta") {
                // Add new meta to metas.json
                const newMeta = submission.meta;
                if (!newMeta || !newMeta.id) {
                    core.setFailed("add_meta: Missing meta object or meta.id");
                    return;
                }
                if (!metas.find(m => m.id === newMeta.id)) {
                    metas.push(newMeta);
                }
                // Link panoid to new meta
                if (!locations[panoid].metas.includes(newMeta.id)) {
                    locations[panoid].metas.push(newMeta.id);
                }
            } else if (submission.action === "link_meta" || submission.action === "link_metas") {
                // Link existing meta(s) to panoid
                const metaIds = submission.action === "link_metas" ? (submission.metaIds || []) : [submission.metaId];
                if (metaIds.length === 0 || (submission.action === "link_meta" && !submission.metaId)) {
                    core.setFailed(`${submission.action}: Missing metaId(s)`);
                    return;
                }
                metaIds.forEach(id => {
                    if (id && !locations[panoid].metas.includes(id)) {
                        locations[panoid].metas.push(id);
                    }
                });
            } else {
                core.setFailed(`Unknown action: ${submission.action}`);
                return;
            }
            
            // Save both files
            fs.writeFileSync(METAS_FILE, JSON.stringify(metas, null, 2));
            fs.writeFileSync(LOCATIONS_FILE, JSON.stringify(locations, null, 2));
            console.log(`Successfully processed ${submission.action} for ${panoid}`);
            return "SUCCESS";

      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/locations.json data/metas.json
          git commit -m "Auto-add meta from Issue #${{ github.event.issue.number }}" || echo "No changes to commit"
          git pull --rebase origin main
          git push

      - name: Close Issue
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "Success: Meta added to database!"
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });
            
            try {
              await github.rest.issues.lock({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                lock_reason: 'resolved'
              });
            } catch (e) {
              console.log("Could not lock issue, but it is closed.");
            }
